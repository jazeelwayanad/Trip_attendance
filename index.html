<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Tour Attendance</title>
                <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
                    <style>
                            /* BASE STYLES */
                                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; padding: 20px; display: flex; justify-content: center; }
                                            .app-container { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
                                                    h1 { text-align: center; color: #111827; margin-bottom: 5px; font-size: 1.5rem; }
                                                            p.sub { text-align: center; color: #6b7280; font-size: 0.9rem; margin-top: 0; }
                                                                    
                                                                            /* INPUTS & BUTTONS */
                                                                                    input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; } /* -webkit-appearance fixes iOS input styles */
                                                                                            button { width: 100%; padding: 14px; background-color: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; touch-action: manipulation; }
                                                                                                    button:disabled { background-color: #93c5fd; }
                                                                                                            
                                                                                                                    /* UTILS */
                                                                                                                            .hidden { display: none !important; }
                                                                                                                                    .success { color: #059669; text-align: center; margin-top: 10px; font-weight: bold; display: none; background: #d1fae5; padding: 10px; border-radius: 8px; }
                                                                                                                                            
                                                                                                                                                    /* ADMIN VIEW */
                                                                                                                                                            .admin-bar { background: #eff6ff; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 1px solid #bfdbfe; }
                                                                                                                                                                    .count { font-size: 1.5rem; font-weight: bold; color: #1e40af; display: block; margin-top: 5px;}
                                                                                                                                                                            
                                                                                                                                                                                    .list-container { max-height: 400px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px; }
                                                                                                                                                                                            .student-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #f3f4f6; }
                                                                                                                                                                                                    .student-name { font-weight: 600; color: #374151; }
                                                                                                                                                                                                            .reg-badge { background: #e5e7eb; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; color: #374151; font-weight: 500; }
                                                                                                                                                                                                                    
                                                                                                                                                                                                                            .reset-btn { background-color: #dc2626; margin-top: 20px; }
                                                                                                                                                                                                                                    .toggle-link { display: block; text-align: center; margin-top: 25px; font-size: 0.9rem; color: #6b7280; text-decoration: underline; cursor: pointer; padding: 10px; }
                                                                                                                                                                                                                                        </style>
                                                                                                                                                                                                                                        </head>
                                                                                                                                                                                                                                        <body>

                                                                                                                                                                                                                                        <div class="app-container">
                                                                                                                                                                                                                                            <h1>üöå Tour Tracker</h1>
                                                                                                                                                                                                                                                <p class="sub" id="status-msg">Mark your attendance</p>

                                                                                                                                                                                                                                                    <div id="student-view">
                                                                                                                                                                                                                                                            <input type="text" id="name" placeholder="Your Name" autocomplete="off">
                                                                                                                                                                                                                                                                    <input type="number" id="reg" placeholder="Reg No (e.g. 101)" autocomplete="off">
                                                                                                                                                                                                                                                                            <button id="btn-mark" onclick="markPresent()">I am Here üôã‚Äç‚ôÇÔ∏è</button>
                                                                                                                                                                                                                                                                                    <div id="success-msg" class="success">‚úÖ Successfully Marked!</div>
                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                            <div id="login-view" class="hidden">
                                                                                                                                                                                                                                                                                                    <h3 style="text-align:center;">Enter Leader Password</h3>
                                                                                                                                                                                                                                                                                                            <input type="password" id="admin-pass" placeholder="Password (Try: 1234)">
                                                                                                                                                                                                                                                                                                                    <button onclick="checkLogin()">Login</button>
                                                                                                                                                                                                                                                                                                                            <button onclick="cancelLogin()" style="background:#9ca3af; margin-top:5px;">Cancel</button>
                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                    <div id="admin-view" class="hidden">
                                                                                                                                                                                                                                                                                                                                            <div class="admin-bar">
                                                                                                                                                                                                                                                                                                                                                        <span>Checked In:</span>
                                                                                                                                                                                                                                                                                                                                                                    <span class="count" id="count-display">0</span>
                                                                                                                                                                                                                                                                                                                                                                            </div>

                                                                                                                                                                                                                                                                                                                                                                                    <div id="student-list" class="list-container">
                                                                                                                                                                                                                                                                                                                                                                                                <p style="text-align:center; color:#ccc; margin-top:20px;">Waiting for students...</p>
                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                <button class="reset-btn" onclick="clearList()">‚ö†Ô∏è CLEAR LIST (Next Location)</button>
                                                                                                                                                                                                                                                                                                                                                                                                                        <button onclick="logout()" style="background:#4b5563; margin-top:10px;">Back to Student View</button>
                                                                                                                                                                                                                                                                                                                                                                                                                            </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                <span id="login-link" class="toggle-link" onclick="showLogin()">Leader Login</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                <script>
                                                                                                                                                                                                                                                                                                                                                                                                                                    // ==========================================
                                                                                                                                                                                                                                                                                                                                                                                                                                        // üî¥ PASTE SUPABASE KEYS HERE
                                                                                                                                                                                                                                                                                                                                                                                                                                            // ==========================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                const SUPABASE_URL = 'https://tffrnkpxxxhyxztmqhxv.supabase.co';
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const SUPABASE_KEY = 'sb_publishable_uLOLSgwdg6NKnL-ehvjNtA_1WVS8ium';
                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ==========================================

                                                                                                                                                                                                                                                                                                                                                                                                                                                            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                // --- STUDENT LOGIC ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async function markPresent() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const name = document.getElementById('name').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const reg = document.getElementById('reg').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const btn = document.getElementById('btn-mark');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!name || !reg) return alert("Please fill both fields!");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    btn.innerText = "Processing...";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            btn.disabled = true;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { error } = await supabase.from('attendance').insert([{ student_name: name, reg_no: reg }]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        alert("Error: " + error.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    btn.disabled = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                btn.innerText = "I am Here üôã‚Äç‚ôÇÔ∏è";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('success-msg').style.display = 'block';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('name').value = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('reg').value = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('success-msg').style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        btn.disabled = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        btn.innerText = "I am Here üôã‚Äç‚ôÇÔ∏è";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, 3000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // --- LOGIN LOGIC (FIXED) ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function showLogin() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('student-view').classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('login-link').classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('login-view').classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function checkLogin() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const pass = document.getElementById('admin-pass').value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (pass === "1234") { // PASSWORD IS HERE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('login-view').classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('admin-view').classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('status-msg').innerText = "Live Monitoring";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fetchList(); // Load data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            alert("Wrong Password");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function cancelLogin() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('login-view').classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('student-view').classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('login-link').classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function logout() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('admin-view').classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('student-view').classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('login-link').classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('status-msg').innerText = "Mark your attendance";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // --- ADMIN LOGIC ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Listen for live updates
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            supabase.channel('room1')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, payload => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if(payload.eventType === 'INSERT') addRow(payload.new);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if(payload.eventType === 'DELETE') { document.getElementById('student-list').innerHTML = ''; updateCount(0); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .subscribe();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async function fetchList() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { data } = await supabase.from('attendance').select('*').order('created_at', { ascending: false });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('student-list').innerHTML = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(data) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                updateCount(data.length);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            data.forEach(addRow);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function addRow(student) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const list = document.getElementById('student-list');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Clear empty msg
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(list.innerText.includes('Waiting')) list.innerHTML = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const div = document.createElement('div');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            div.className = 'student-row';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    div.innerHTML = `<span class="student-name">${student.student_name}</span> <span class="reg-badge">${student.reg_no}</span>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            list.prepend(div);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Update count purely based on list items
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    updateCount(list.children.length);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function updateCount(num) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('count-display').innerText = num;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async function clearList() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(confirm("DELETE ALL DATA for next location?")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await supabase.from('attendance').delete().gt('id', 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </html>